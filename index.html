<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>This Week's Drop</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#05060a;
  --text:#f7f8ff;
  --muted: rgba(255,255,255,0.7);

  /* Color psychology */
  --blue:#4da3ff;    /* trust */
  --green:#38d66b;   /* value/money */
  --gold:#ffcf4a;    /* status */
  --red:#ff3b3b;     /* urgency */
  --purple:#b46bff;  /* hype */
}

*{ box-sizing:border-box; }
body{
  margin:0;
  font-family:Inter, Arial, sans-serif;
  background: radial-gradient(1200px 800px at 50% -20%, rgba(180,107,255,0.25), transparent 60%),
              radial-gradient(900px 700px at 20% 10%, rgba(77,163,255,0.18), transparent 60%),
              radial-gradient(900px 700px at 80% 20%, rgba(56,214,107,0.10), transparent 60%),
              var(--bg);
  color:var(--text);
  text-align:center;
  min-height:100vh;
  padding-bottom:72px; /* admin bar space */
}

.container{ padding:24px 16px; max-width:820px; margin:0 auto; }

.h1{
  font-weight:800;
  letter-spacing:0.5px;
  margin:18px 0 10px;
  font-size:42px;
  text-shadow: 0 0 24px rgba(180,107,255,0.25);
}
.sub{
  color:var(--muted);
  margin-top:6px;
  font-size:15px;
}

.hero-card{
  margin:18px auto 18px;
  padding:18px 16px;
  border-radius:18px;
  background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
  border:1px solid rgba(255,255,255,0.14);
  box-shadow: 0 14px 60px rgba(0,0,0,0.55);
  position:relative;
  overflow:hidden;
}
.hero-card:before{
  content:"";
  position:absolute;
  inset:-2px;
  background: radial-gradient(600px 280px at 50% 0%, rgba(255,207,74,0.12), transparent 60%),
              radial-gradient(700px 320px at 30% 20%, rgba(77,163,255,0.12), transparent 60%),
              radial-gradient(700px 320px at 70% 30%, rgba(180,107,255,0.12), transparent 60%);
  pointer-events:none;
}
.hero-card > *{ position:relative; z-index:1; }

.timer{
  font-size:30px;
  font-weight:800;
  margin:8px 0 4px;
  display:inline-flex;
  gap:10px;
  align-items:center;
  justify-content:center;
}
.timer small{
  font-size:14px;
  color:var(--muted);
  font-weight:600;
}

.badge-row{
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  margin:14px 0 18px;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:999px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.12);
  backdrop-filter: blur(10px);
  font-weight:600;
  font-size:13px;
}
.badge.cancel{
  background: rgba(56,214,107,0.10);
  border: 1px solid rgba(56,214,107,0.30);
  box-shadow: 0 0 24px rgba(56,214,107,0.15);
}
.badge.hot{
  background: rgba(255,59,59,0.10);
  border: 1px solid rgba(255,59,59,0.30);
}
.pulse{
  animation: pulse 1.3s infinite;
}
@keyframes pulse{
  0%{ box-shadow: 0 0 0 0 rgba(255,59,59,0.35); }
  70%{ box-shadow: 0 0 0 14px rgba(255,59,59,0.0); }
  100%{ box-shadow: 0 0 0 0 rgba(255,59,59,0.0); }
}

.primary-btn{
  border:none;
  border-radius:14px;
  padding:16px 18px;
  font-size:18px;
  font-weight:800;
  cursor:pointer;
  width:min(340px, 92%);
  margin-top:14px;
  background: linear-gradient(90deg, var(--purple), var(--blue));
  color:white;
  box-shadow: 0 12px 40px rgba(180,107,255,0.25);
  transition: transform .12s ease, filter .12s ease;
}
.primary-btn:active{ transform: scale(0.98); filter:brightness(0.95); }

.section-title{
  margin:22px 0 10px;
  font-weight:800;
  font-size:18px;
  letter-spacing:0.2px;
}

.tiers{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:12px;
  margin:12px auto 10px;
}
@media (max-width: 720px){
  .tiers{ grid-template-columns: 1fr; }
}

.tier{
  text-align:left;
  padding:16px;
  border-radius:16px;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
  box-shadow: 0 12px 40px rgba(0,0,0,0.35);
  position:relative;
  overflow:hidden;
}
.tier:before{
  content:"";
  position:absolute;
  inset:-2px;
  opacity:0.9;
  pointer-events:none;
}
.tier.basic:before{ background: radial-gradient(550px 250px at 30% 20%, rgba(77,163,255,0.22), transparent 60%); }
.tier.vip:before{ background: radial-gradient(550px 250px at 30% 20%, rgba(56,214,107,0.22), transparent 60%); }
.tier.elite:before{ background: radial-gradient(550px 250px at 30% 20%, rgba(255,207,74,0.20), transparent 60%); }
.tier > *{ position:relative; z-index:1; }

.tier h3{ margin:2px 0 6px; font-size:20px; }
.tier p{ margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.35; }

.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  font-weight:800;
  padding:8px 10px;
  border-radius:999px;
  margin-bottom:10px;
  border:1px solid rgba(255,255,255,0.16);
  background: rgba(0,0,0,0.25);
}
.pill.basic{ color: var(--blue); border-color: rgba(77,163,255,0.35); }
.pill.vip{ color: var(--green); border-color: rgba(56,214,107,0.35); }
.pill.elite{ color: var(--gold); border-color: rgba(255,207,74,0.35); }

.buy-btn{
  width:100%;
  border:none;
  border-radius:14px;
  padding:14px 14px;
  font-size:16px;
  font-weight:900;
  cursor:pointer;
  color:#0b0b0b;
  margin-top:6px;
  transition: transform .12s ease, filter .12s ease;
}
.buy-btn:active{ transform: scale(0.98); filter:brightness(0.95); }
.buy-basic{ background: linear-gradient(90deg, rgba(77,163,255,0.95), rgba(77,163,255,0.75)); }
.buy-vip{ background: linear-gradient(90deg, rgba(56,214,107,0.95), rgba(56,214,107,0.75)); }
.buy-elite{ background: linear-gradient(90deg, rgba(255,207,74,0.98), rgba(255,207,74,0.75)); }

.small-note{ margin-top:10px; color:var(--muted); font-size:12px; }

/* ===== MODALS (solid + readable) ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.97);
  backdrop-filter: blur(14px);
  overflow:auto;
  padding:18px 12px 90px;
  z-index:9999;
}
.modal-card{
  max-width:560px;
  margin:20px auto;
  background:#0f1117; /* SOLID */
  border: 1px solid rgba(255,255,255,0.10);
  border-radius:18px;
  padding:20px;
  box-shadow: 0 40px 120px rgba(0,0,0,0.9);
  text-align:left;
  position:relative;
  overflow:hidden;
}

/* Top glow line (signup + admin) */
.modal-card::before{
  content:"";
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:3px;
  background: linear-gradient(90deg, #38d66b, #4da3ff, #b46bff);
  border-radius: 18px 18px 0 0;
}

.modal-card h2{ margin:6px 0 12px; text-align:center; position:relative; z-index:1; }

.field{
  width:100%;
  padding:12px 12px;
  margin:8px 0;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.16);
  background:#151822; /* readable */
  color:var(--text);
  outline:none;
  position:relative;
  z-index:1;
}
.field::placeholder{ color: rgba(255,255,255,0.55); }

.row{ display:flex; gap:10px; position:relative; z-index:1; }
@media(max-width:560px){ .row{ flex-direction:column; } }

.modal-actions{
  display:flex;
  gap:10px;
  margin-top:12px;
  position:relative;
  z-index:1;
}
.action{
  flex:1;
  border:none;
  border-radius:14px;
  padding:14px 14px;
  font-size:15px;
  font-weight:900;
  cursor:pointer;
}
.action.submit{
  background: linear-gradient(90deg, var(--green), rgba(56,214,107,0.7));
  color:#07160c;
}
.action.cancel{
  background: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.20);
  color: var(--text);
}

hr.sep{ border:none; border-top:1px solid rgba(255,255,255,0.10); margin:12px 0; }

/* ADMIN BAR */
.admin-bar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background: rgba(10,10,16,0.85);
  backdrop-filter: blur(10px);
  border-top:1px solid rgba(255,255,255,0.12);
  padding:10px 10px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  z-index:99999;
}
.admin-bar input{
  width:min(520px, 65%);
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.08);
  color: var(--text);
}
.admin-bar button{
  padding:12px 14px;
  border-radius:12px;
  border:none;
  font-weight:900;
  cursor:pointer;
  background: linear-gradient(90deg, var(--purple), var(--blue));
  color:white;
}

/* Admin cards */
.table-card{
  margin:10px 0;
  padding:14px;
  border-radius:14px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  position:relative;
  z-index:1;
}
.table-card strong{ font-size:14px; }
.kv{ color: var(--muted); font-size:12px; line-height:1.45; margin-top:6px; }
.kv b{ color: var(--text); }

.admin-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
}
.admin-actions button{
  flex:1;
  min-width: 160px;
  border:none;
  border-radius:12px;
  padding:10px;
  font-weight:900;
  cursor:pointer;
}
.btn-used{ background: rgba(56,214,107,0.18); border:1px solid rgba(56,214,107,0.35); color: var(--text); }
.btn-warn{ background: rgba(255,207,74,0.14); border:1px solid rgba(255,207,74,0.35); color: var(--text); }
.btn-reset{ background: rgba(255,59,59,0.14); border:1px solid rgba(255,59,59,0.35); color: var(--text); }
.btn-blue{ background: rgba(77,163,255,0.16); border:1px solid rgba(77,163,255,0.35); color: var(--text); }

.checkboxRow{
  display:flex;
  gap:10px;
  align-items:flex-start;
  margin-top:6px;
  text-align:left;
  color: rgba(255,255,255,0.8);
  font-size:12px;
  line-height:1.35;
  position:relative;
  z-index:1;
}
.checkboxRow input{ margin-top:2px; }
  /* ===== MENU BUTTON ===== */
.menu-btn{
margin: 10px auto 12px;
border:none;
border-radius:14px;
padding:14px 16px;
font-size:16px;
font-weight:900;
cursor:pointer;
width:min(360px, 92%);
color: var(--text);
background: rgba(255,255,255,0.08);
border: 1px solid rgba(255,255,255,0.16);
backdrop-filter: blur(10px);
box-shadow: 0 14px 50px rgba(0,0,0,0.45);
transition: transform .12s ease, filter .12s ease;
}
.menu-btn:active{ transform: scale(0.98); filter: brightness(0.95); }

/* ===== MENU PANEL (glass square) ===== */
.menu-panel{
display:none;
width:min(540px, 92%);
margin: 0 auto 14px;
border-radius:18px;
position:relative;
overflow:hidden;
background: rgba(255,255,255,0.07);
border: 1px solid rgba(255,255,255,0.14);
backdrop-filter: blur(14px);
box-shadow: 0 18px 70px rgba(0,0,0,0.55);
}

/* Inner content layer */
.menu-inner{
position:relative;
z-index:2;
padding:18px;
text-align:left;
}
.menu-title{
font-size:18px;
font-weight:900;
letter-spacing:0.2px;
}
.menu-sub{
color: rgba(255,255,255,0.7);
font-size:12px;
margin-top:4px;
}

/* Menu links */
.menu-links{
display:grid;
grid-template-columns: 1fr 1fr;
gap:10px;
margin-top:14px;
}
@media(max-width:520px){
.menu-links{ grid-template-columns: 1fr; }
}
.menu-link{
border:none;
border-radius:14px;
padding:12px 12px;
font-weight:900;
cursor:pointer;
color: var(--text);
background: rgba(0,0,0,0.35);
border: 1px solid rgba(255,255,255,0.12);
transition: transform .12s ease, filter .12s ease;
}
.menu-link:active{ transform: scale(0.98); filter: brightness(0.95); }

/* ===== STAR BACKGROUND (falling + twinkling) ===== */
.menu-stars{
position:absolute;
inset:0;
z-index:1;
pointer-events:none;
opacity:0.55; /* semi-seeable */
}

/* Two star layers using repeating radial gradients */
.menu-stars::before,
.menu-stars::after{
content:"";
position:absolute;
inset:-80px 0 0 0; /* extra top space so falling looks continuous */
background-repeat: repeat;
animation-timing-function: linear;
}

/* Small stars layer */
.menu-stars::before{
background-image:
radial-gradient(circle, rgba(255,255,255,0.9) 1px, transparent 1.6px),
radial-gradient(circle, rgba(255,255,255,0.6) 1px, transparent 1.8px);
background-size: 110px 140px, 170px 210px;
background-position: 0 0, 40px 60px;
animation: starsFall 16s linear infinite, starsTwinkle 2.8s ease-in-out infinite;
filter: blur(0.1px);
}

/* Bigger stars layer (slower, softer) */
.menu-stars::after{
background-image:
radial-gradient(circle, rgba(255,255,255,0.75) 1.2px, transparent 2.2px),
radial-gradient(circle, rgba(255,207,74,0.25) 1.4px, transparent 2.6px);
background-size: 220px 260px, 300px 340px;
background-position: 20px 20px, 100px 120px;
animation: starsFall 28s linear infinite, starsTwinkle2 4.2s ease-in-out infinite;
opacity:0.6;
filter: blur(0.25px);
}

@keyframes starsFall{
from { transform: translateY(-60px); }
to { transform: translateY(260px); } /* slow falling */
}

@keyframes starsTwinkle{
0%,100% { opacity: 0.55; }
50% { opacity: 0.92; }
}

@keyframes starsTwinkle2{
0%,100% { opacity: 0.35; }
50% { opacity: 0.70; }
}
</style>
</head>

<body>
  <div class="container">
    <div class="hero-card">
      <div class="h1">üî• THIS WEEK'S DROP</div>

      <div class="timer">
        ‚è≥ <span id="timer">10:00</span>
        <small>ends soon</small>
      </div>

      <div class="badge-row">
        <div class="badge hot pulse">‚ö° Limited spots</div>
        <div class="badge cancel">‚úÖ Cancel anytime</div>
        <div class="badge">üîí Secret drops for Elite</div>
      </div>

      <div class="sub">
        Pick a club. Grab your spot. Get restock texts if you want. No lock-in.
      </div>

      <button class="primary-btn" onclick="scrollToClubs()">View Clubs</button>
      <div class="small-note">Cancel anytime = stop whenever you want. No stress.</div>
    </div>

    <div id="clubs"></div>

<!-- MENU BUTTON (right before clubs) -->
<button class="menu-btn" onclick="toggleMenu()">‚ò∞ Menu</button>

<!-- MENU PANEL -->
<div id="menuPanel" class="menu-panel">
<div class="menu-stars"></div>
<div class="menu-inner">
<div class="menu-title">Drop Menu</div>
<div class="menu-sub">Fast links + info</div>

<div class="menu-links">
<button class="menu-link" onclick="scrollToClubs(); toggleMenu(false)">‚≠ê Clubs</button>
<button class="menu-link" onclick="show('signupModal'); toggleMenu(false)">üìù Join</button>
<button class="menu-link" onclick="toggleMenu(false); alert('VIP: Free treat weekly ‚Ä¢ Elite: Secret drops + priority')">üéÅ Perks</button>
<button class="menu-link" onclick="toggleMenu(false); alert('Cancel anytime. No lock-in.')">‚úÖ Cancel Anytime</button>
</div>
</div>
</div>

<div class="section-title">Choose your club</div>
    
    <div class="section-title">Choose your club</div>

    <div class="tiers">
      <div class="tier basic">
        <div class="pill basic">üßä BASIC ‚Ä¢ Trust</div>
        <h3>Basic</h3>
        <p>First access + guaranteed spot in the lineup.</p>
        <button class="buy-btn buy-basic" onclick="pickTier('Basic')">Claim Basic</button>
      </div>

      <div class="tier vip">
        <div class="pill vip">üí∏ VIP ‚Ä¢ Best Value</div>
        <h3>VIP</h3>
        <p>First access + VIP line + weekly free treat.</p>
        <button class="buy-btn buy-vip" onclick="pickTier('VIP')">Claim VIP</button>
      </div>

      <div class="tier elite">
        <div class="pill elite">üèÜ ELITE 25 ‚Ä¢ Status</div>
        <h3>Elite 25</h3>
        <p>Everything in VIP + priority + secret drops.</p>
        <button class="buy-btn buy-elite" onclick="pickTier('Elite 25')">Claim Elite</button>
      </div>
    </div>

    <div class="small-note">
      This page stores signups on THIS device (localStorage). For cross-phone sync, you‚Äôll want Google Sheets/Supabase later.
    </div>
  </div>

  <!-- SIGNUP MODAL -->
  <div id="signupModal" class="modal">
    <div class="modal-card">
      <h2 id="signupTitle">Join</h2>
      <div class="small-note" style="text-align:center;margin-bottom:8px;">
        ‚úÖ Cancel anytime ‚Ä¢ takes 10 seconds
      </div>

      <div class="row">
        <input class="field" id="firstName" placeholder="First Name">
        <input class="field" id="lastName" placeholder="Last Name">
      </div>

      <input class="field" id="phone" placeholder="Phone Number (optional) e.g. 8015551234" inputmode="tel">

      <div class="checkboxRow">
        <input type="checkbox" id="smsConsent">
        <div>
          Yes ‚Äî text me restocks + secret drops + ‚Äústock up‚Äù alerts. Reply <b>STOP</b> to opt out. Msg & data rates may apply.
        </div>
      </div>

      <div class="row">
        <select class="field" id="lunch">
          <option value="">Select Lunch</option>
          <option value="A">A Lunch</option>
          <option value="B">B Lunch</option>
        </select>

        <select class="field" id="timePref" onchange="checkOther()">
          <option value="">When do you buy?</option>
          <option value="Lunch">Lunch</option>
          <option value="Before School">Before School</option>
          <option value="After School">After School</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <input class="field" id="otherField" placeholder="If Other: class + period (ex: Biology 3rd)" style="display:none;">

      <div class="modal-actions">
        <button class="action submit" onclick="submitSignup()">Submit</button>
        <button class="action cancel" onclick="closeSignup()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="modal">
    <div class="modal-card">
      <h2>Admin Dashboard</h2>
      <div class="small-note" style="text-align:center;">
        Track signups, due dates, expired, and perk usage.
      </div>

      <div class="modal-actions" style="margin-top:10px;">
        <button class="action submit" onclick="openTextModal()">Send Out Text</button>
        <button class="action cancel" onclick="exportCSV()">Export Signups CSV</button>
      </div>

      <hr class="sep">
      <div id="adminData"></div>

      <div class="modal-actions">
        <button class="action cancel" onclick="closeAdmin()">Close</button>
        <button class="action submit" onclick="wipeAll()">Wipe Device Data</button>
      </div>
    </div>
  </div>

  <!-- TEXT MODAL -->
  <div id="textModal" class="modal">
    <div class="modal-card">
      <h2>Send Out Text</h2>
      <div class="small-note" style="text-align:center;">
        This generates messages + exports a CSV (phone, message). No automatic SMS sending in this version.
      </div>

      <select class="field" id="textType" onchange="toggleItemField()">
        <option value="new_stock">New stock</option>
        <option value="leaving_soon">Stock leaving soon</option>
        <option value="new_item">New item (type item name)</option>
        <option value="secret_drop">Secret drop (Elite only)</option>
      </select>

      <input class="field" id="itemName" placeholder="Item name (e.g., Sour Punch Bites)" style="display:none;">

      <select class="field" id="audience">
        <option value="all">Audience: All (with consent)</option>
        <option value="vip_plus">Audience: VIP + Elite</option>
        <option value="elite_only">Audience: Elite only</option>
      </select>

      <div class="modal-actions">
        <button class="action submit" onclick="generateTextCSV()">Generate CSV</button>
        <button class="action cancel" onclick="closeTextModal()">Cancel</button>
      </div>

      <div class="small-note" style="margin-top:10px;">
        Tip: only people who checked the consent box will be included.
      </div>
    </div>
  </div>

  <!-- ADMIN BAR -->
  <div class="admin-bar">
    <input id="adminCode" placeholder="Admin Code">
    <button onclick="adminLogin()">Login</button>
  </div>

<script>
  function toggleMenu(force){
const panel = document.getElementById("menuPanel");
const showIt = (typeof force === "boolean") ? force : (panel.style.display !== "block");
panel.style.display = showIt ? "block" : "none";
}
/*** CONFIG ***/
const ADMIN_CODE = "1234";        // change this
const SUB_LENGTH_DAYS = 7;        // weekly subscription
let selectedTier = null;

/*** TIERS + PERKS ***/
const perksByTier = {
  "Basic":   { firstAccess: true },
  "VIP":     { firstAccess: true, weeklyFreeTreat: true, vipLine: true },
  "Elite 25":{ firstAccess: true, weeklyFreeTreat: true, vipLine: true, secretDrops: true, priority: true }
};

/*** TIMER (10 minutes demo) ***/
let countdown = 600;
const timerEl = document.getElementById("timer");
setInterval(()=>{
  let m = Math.floor(countdown/60);
  let s = countdown%60;
  timerEl.textContent = `${m}:${s<10?'0'+s:s}`;
  countdown = Math.max(0, countdown-1);
},1000);

function scrollToClubs(){
  document.getElementById("clubs").scrollIntoView({behavior:"smooth"});
}

/*** MODAL HELPERS ***/
function show(elId){ document.getElementById(elId).style.display = "block"; }
function hide(elId){ document.getElementById(elId).style.display = "none"; }

/*** SIGNUP FLOW ***/
function pickTier(tier){
  selectedTier = tier;
  document.getElementById("signupTitle").innerText = `Join ${tier}`;
  show("signupModal");
}

function closeSignup(){
  hide("signupModal");
}

function checkOther(){
  const v = document.getElementById("timePref").value;
  document.getElementById("otherField").style.display = (v === "Other") ? "block" : "none";
}

function submitSignup(){
  const first = document.getElementById("firstName").value.trim();
  const last  = document.getElementById("lastName").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const smsConsent = document.getElementById("smsConsent").checked;

  const lunch = document.getElementById("lunch").value;
  const time  = document.getElementById("timePref").value;
  const other = document.getElementById("otherField").value.trim();

  if(!selectedTier){ alert("Pick a club first."); return; }
  if(!first || !last){ alert("Add first + last name."); return; }
  if(!lunch){ alert("Select A or B lunch."); return; }
  if(!time){ alert("Select when you buy."); return; }
  if(time === "Other" && !other){ alert("Type the class + period."); return; }

  // If they typed a phone, require consent checkbox
  if(phone && !smsConsent){
    alert('To get texts, check the consent box (you can opt out anytime by replying "STOP").');
    return;
  }

  const joined = new Date();
  const due = new Date(joined.getTime() + SUB_LENGTH_DAYS*24*60*60*1000);

  const data = {
    id: cryptoId(),
    tier: selectedTier,
    first, last,
    phone,
    smsConsent,
    lunch,
    time,
    other: (time === "Other") ? other : "",
    joinedISO: joined.toISOString(),
    dueISO: due.toISOString(),
    cancelled: false,
    cancelledAtISO: "",
    smsOptedOut: false,

    // perks available for tier
    perks: perksByTier[selectedTier],

    // perk usage toggles (only applies if perk exists in perks)
    perksUsed: {
      weeklyFreeTreat: false,
      vipLine: false,
      secretDrops: false,
      priority: false
    }
  };

  const users = loadUsers();
  users.push(data);
  saveUsers(users);

  // Flashy "subscribed" message (simulated)
  if (phone && smsConsent){
    const firstLiner = randomHookLine(first);
    alert(
      `${firstLiner}\n\n‚úÖ You‚Äôre now receiving restocks + secret treats + stock-up alerts.\nReply STOP to opt out.\n\nWant more perks? Upgrade to ELITE 25 üëë`
    );
  } else {
    alert(`You're in ‚úÖ\n${selectedTier}\nCancel anytime.`);
  }

  closeSignup();
  resetFormFields();
}

function resetFormFields(){
  document.getElementById("firstName").value="";
  document.getElementById("lastName").value="";
  document.getElementById("phone").value="";
  document.getElementById("smsConsent").checked=false;
  document.getElementById("lunch").value="";
  document.getElementById("timePref").value="";
  document.getElementById("otherField").value="";
  document.getElementById("otherField").style.display="none";
}

/*** Random hook line + upsell seed ***/
function randomHookLine(name){
  const hooks = [
    "Click before we sell out",
    "You‚Äôve been chosen",
    "Your access just unlocked",
    "Don‚Äôt miss this week‚Äôs drop",
    "VIP eyes only (for now)",
    "Lowkey‚Ä¶ this one disappears fast"
  ];
  const pick = hooks[Math.floor(Math.random()*hooks.length)];
  return `${name} ‚Äî ${pick}.`;
}

/*** STORAGE ***/
function loadUsers(){
  return JSON.parse(localStorage.getItem("drop_users") || "[]");
}
function saveUsers(users){
  localStorage.setItem("drop_users", JSON.stringify(users));
}
function cryptoId(){
  return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now();
}

/*** ADMIN ***/
function adminLogin(){
  const code = document.getElementById("adminCode").value.trim();
  if(code === ADMIN_CODE){
    loadAdmin();
    show("adminPanel");
  } else {
    alert("Wrong code.");
  }
}
function closeAdmin(){
  hide("adminPanel");
}
function isExpired(u){
  if(u.cancelled) return true;
  return new Date() > new Date(u.dueISO);
}
function fmt(ts){
  try { return new Date(ts).toLocaleString(); } catch(e){ return ""; }
}

function loadAdmin(){
  const users = loadUsers();
  if(users.length === 0){
    document.getElementById("adminData").innerHTML = `<div class="table-card">No signups yet.</div>`;
    return;
  }

  let html = "";
  users.forEach((u)=>{
    const expired = isExpired(u);
    const status = expired ? "Expired" : "Active";
    const statusColor = expired ? "rgba(255,59,59,0.95)" : "rgba(56,214,107,0.95)";

    const buyTime = u.time + (u.other ? ` (${u.other})` : "");
    const canSMS = !!(u.phone && u.smsConsent && !u.smsOptedOut);

    html += `
      <div class="table-card">
        <strong>${escapeHtml(u.first)} ${escapeHtml(u.last)}</strong>

        <div class="kv">
          Tier: <b>${escapeHtml(u.tier)}</b><br>
          Lunch: <b>${escapeHtml(u.lunch)}</b><br>
          Buy time: <b>${escapeHtml(buyTime)}</b><br>
          Joined: <b>${escapeHtml(fmt(u.joinedISO))}</b><br>
          Due: <b>${escapeHtml(fmt(u.dueISO))}</b><br>
          Status: <b style="color:${statusColor}">${status}</b><br>
          Phone: <b>${u.phone ? escapeHtml(u.phone) : "‚Äî"}</b><br>
          SMS Eligible: <b>${canSMS ? "Yes" : "No"}</b>
        </div>

        <div class="admin-actions">
          <button class="btn-blue" onclick="renew('${u.id}')">Renew +${SUB_LENGTH_DAYS}d</button>
          <button class="btn-reset" onclick="toggleCancel('${u.id}')">${u.cancelled ? "Un-cancel" : "Cancel Sub"}</button>
        </div>

        <div class="admin-actions" style="margin-top:8px;">
          ${perkButton(u, "weeklyFreeTreat", "Free Treat")}
          ${perkButton(u, "vipLine", "VIP Line")}
          ${perkButton(u, "secretDrops", "Secret Drop")}
          ${perkButton(u, "priority", "Priority")}
        </div>

        <div class="small-note" style="margin-top:8px;">
          Note: Basic has no perks to mark ‚Äúused‚Äù except first access (not tracked). VIP/Elite perks are tracked here.
        </div>
      </div>
    `;
  });

  document.getElementById("adminData").innerHTML = html;
}

function perkButton(u, perkKey, label){
  // Only show if this tier includes the perk
  if(!u.perks || !u.perks[perkKey]) return "";
  const used = !!(u.perksUsed && u.perksUsed[perkKey]);
  const cls = used ? "btn-warn" : "btn-used";
  const text = used ? `Undo ${label}` : `Mark ${label} Used`;
  return `<button class="${cls}" onclick="togglePerk('${u.id}','${perkKey}')">${text}</button>`;
}

function togglePerk(id, perkKey){
  const users = loadUsers();
  const u = users.find(x=>x.id===id);
  if(!u) return;

  // Only allow if perk exists for that tier
  if(!u.perks || !u.perks[perkKey]) return;

  if(!u.perksUsed) u.perksUsed = {};
  u.perksUsed[perkKey] = !u.perksUsed[perkKey];

  saveUsers(users);
  loadAdmin();
}

function toggleCancel(id){
  const users = loadUsers();
  const u = users.find(x=>x.id===id);
  if(!u) return;

  u.cancelled = !u.cancelled;
  u.cancelledAtISO = u.cancelled ? new Date().toISOString() : "";
  saveUsers(users);
  loadAdmin();
}

function renew(id){
  const users = loadUsers();
  const u = users.find(x=>x.id===id);
  if(!u) return;

  const base = Math.max(Date.now(), new Date(u.dueISO).getTime());
  u.dueISO = new Date(base + SUB_LENGTH_DAYS*24*60*60*1000).toISOString();
  u.cancelled = false;
  u.cancelledAtISO = "";
  saveUsers(users);
  loadAdmin();
}

function wipeAll(){
  const ok = confirm("Wipe ALL signups on this device?");
  if(!ok) return;
  localStorage.removeItem("drop_users");
  loadAdmin();
}

/*** TEXT SENDER (CSV generator) ***/
function openTextModal(){
  document.getElementById("textType").value = "new_stock";
  document.getElementById("audience").value = "all";
  document.getElementById("itemName").value = "";
  document.getElementById("itemName").style.display = "none";
  show("textModal");
}
function closeTextModal(){
  hide("textModal");
}
function toggleItemField(){
  const t = document.getElementById("textType").value;
  document.getElementById("itemName").style.display = (t === "new_item") ? "block" : "none";
}

function generateTextCSV(){
  const type = document.getElementById("textType").value;
  const audience = document.getElementById("audience").value;
  const itemName = document.getElementById("itemName").value.trim();

  if(type === "new_item" && !itemName){
    alert("Type the item name first.");
    return;
  }

  const users = loadUsers();

  // Only include: has phone + consent + not opted out
  let targets = users.filter(u => u.phone && u.smsConsent && !u.smsOptedOut);

  // Audience filter
  if(audience === "vip_plus"){
    targets = targets.filter(u => u.tier === "VIP" || u.tier === "Elite 25");
  }
  if(audience === "elite_only"){
    targets = targets.filter(u => u.tier === "Elite 25");
  }

  // Secret drop should be Elite only
  if(type === "secret_drop"){
    targets = targets.filter(u => u.tier === "Elite 25");
  }

  if(targets.length === 0){
    alert("No eligible phone numbers for that audience/type.");
    return;
  }

  const rows = [["phone","message"]];
  for(const u of targets){
    const msg = buildSms(u, type, itemName);
    rows.push([u.phone, msg]);
  }

  const csv = rows.map(r => r.map(x => `"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
  downloadFile("texts_to_send.csv", csv, "text/csv");
  alert(`Generated CSV for ${targets.length} texts ‚úÖ`);
  closeTextModal();
}

function buildSms(u, type, itemName){
  const opener = randomHookLine(u.first);

  // Template core
  let core = "";
  if(type === "new_stock"){
    core = "Restock just landed. Stock up before lunch.";
  } else if(type === "leaving_soon"){
    core = "Heads up ‚Äî stock is leaving soon. Last chance before it‚Äôs gone.";
  } else if(type === "new_item"){
    core = `New item drop: ${itemName}. Limited amount today.`;
  } else if(type === "secret_drop"){
    core = "Secret drop active. Ask for the hidden menu item today.";
  }

  // Upsell (every text)
  let upsell = "";
  if(u.tier === "Basic"){
    upsell = "Want more perks? Upgrade to VIP for weekly free treats or ELITE 25 for secret drops üëë";
  } else if(u.tier === "VIP"){
    upsell = "Level up to ELITE 25 for priority + secret drops üëë";
  } else {
    upsell = "Elite status stays undefeated üëë";
  }

  // STOP line
  const stop = 'Reply STOP to opt out.';

  // Keep it short-ish for SMS
  return `${opener} ${core} ${upsell} ${stop}`;
}

/*** Export signups CSV ***/
function exportCSV(){
  const users = loadUsers();
  const headers = [
    "Tier","First","Last","Phone","SMSConsent","Lunch","BuyTime","Other","Joined","Due","Expired","Cancelled",
    "Used_FreeTreat","Used_VIPLine","Used_SecretDrop","Used_Priority"
  ];
  const rows = users.map(u=>[
    u.tier, u.first, u.last, u.phone || "", u.smsConsent ? "Yes":"No",
    u.lunch, u.time, u.other || "",
    u.joinedISO, u.dueISO,
    isExpired(u) ? "Yes":"No",
    u.cancelled ? "Yes":"No",
    u.perksUsed?.weeklyFreeTreat ? "Yes":"No",
    u.perksUsed?.vipLine ? "Yes":"No",
    u.perksUsed?.secretDrops ? "Yes":"No",
    u.perksUsed?.priority ? "Yes":"No"
  ]);

  const csv = [headers, ...rows]
    .map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(","))
    .join("\n");

  downloadFile("drop_signups.csv", csv, "text/csv");
}

/*** Utils ***/
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function downloadFile(filename, content, type){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
