<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>This Week's Drop</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#05060a;
  --text:#f7f8ff;
  --muted: rgba(255,255,255,0.7);

  --blue:#4da3ff;
  --green:#38d66b;
  --gold:#ffcf4a;
  --red:#ff3b3b;
  --purple:#b46bff;
}

*{ box-sizing:border-box; }
body{
  margin:0;
  font-family:Inter, Arial, sans-serif;
  background: radial-gradient(1200px 800px at 50% -20%, rgba(180,107,255,0.25), transparent 60%),
              radial-gradient(900px 700px at 20% 10%, rgba(77,163,255,0.18), transparent 60%),
              radial-gradient(900px 700px at 80% 20%, rgba(56,214,107,0.10), transparent 60%),
              var(--bg);
  color:var(--text);
  text-align:center;
  min-height:100vh;
  padding-bottom:72px;
}

/* Top-left logo */
.brand-logo{
  position:fixed;
  top:12px;
  left:12px;
  z-index:99998;
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.07);
  backdrop-filter: blur(12px);
  box-shadow: 0 18px 70px rgba(0,0,0,0.35);
  cursor:pointer;
  user-select:none;
}
.brand-logo span{
  font-weight:900;
  letter-spacing:.2px;
}

/* Welcome toast */
.toast{
  position:fixed;
  top:70px;
  left:50%;
  transform:translateX(-50%);
  z-index:99999;
  padding:12px 14px;
  border-radius:14px;
  background: rgba(56,214,107,0.14);
  border:1px solid rgba(56,214,107,0.32);
  color:#b7ffd0;
  font-weight:900;
  box-shadow: 0 18px 80px rgba(0,0,0,0.55);
  opacity:0;
  pointer-events:none;
  transition: opacity 1.2s ease;
}
.toast.show{ opacity:1; }
.toast.fade{ opacity:0; }

.container{ padding:24px 16px; max-width:820px; margin:0 auto; }

.h1{
  font-weight:800;
  letter-spacing:0.5px;
  margin:18px 0 10px;
  font-size:42px;
  text-shadow: 0 0 24px rgba(180,107,255,0.25);
}
.sub{ color:var(--muted); margin-top:6px; font-size:15px; }

.hero-card{
  margin:18px auto 18px;
  padding:18px 16px;
  border-radius:18px;
  background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
  border:1px solid rgba(255,255,255,0.14);
  box-shadow: 0 14px 60px rgba(0,0,0,0.55);
  position:relative;
  overflow:hidden;
}
.hero-card:before{
  content:"";
  position:absolute;
  inset:-2px;
  background: radial-gradient(600px 280px at 50% 0%, rgba(255,207,74,0.12), transparent 60%),
              radial-gradient(700px 320px at 30% 20%, rgba(77,163,255,0.12), transparent 60%),
              radial-gradient(700px 320px at 70% 30%, rgba(180,107,255,0.12), transparent 60%);
  pointer-events:none;
}
.hero-card > *{ position:relative; z-index:1; }

.timer{
  font-size:30px;
  font-weight:800;
  margin:8px 0 4px;
  display:inline-flex;
  gap:10px;
  align-items:center;
  justify-content:center;
}
.timer small{ font-size:14px; color:var(--muted); font-weight:600; }

.badge-row{
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  margin:14px 0 18px;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:999px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.12);
  backdrop-filter: blur(10px);
  font-weight:600;
  font-size:13px;
}
.badge.cancel{
  background: rgba(56,214,107,0.10);
  border: 1px solid rgba(56,214,107,0.30);
  box-shadow: 0 0 24px rgba(56,214,107,0.15);
}
.badge.hot{
  background: rgba(255,59,59,0.10);
  border: 1px solid rgba(255,59,59,0.30);
}
.pulse{ animation: pulse 1.3s infinite; }
@keyframes pulse{
  0%{ box-shadow: 0 0 0 0 rgba(255,59,59,0.35); }
  70%{ box-shadow: 0 0 0 14px rgba(255,59,59,0.0); }
  100%{ box-shadow: 0 0 0 0 rgba(255,59,59,0.0); }
}

.primary-btn{
  border:none;
  border-radius:14px;
  padding:16px 18px;
  font-size:18px;
  font-weight:800;
  cursor:pointer;
  width:min(340px, 92%);
  margin-top:14px;
  background: linear-gradient(90deg, var(--purple), var(--blue));
  color:white;
  box-shadow: 0 12px 40px rgba(180,107,255,0.25);
  transition: transform .12s ease, filter .12s ease;
}
.primary-btn:active{ transform: scale(0.98); filter:brightness(0.95); }

.section-title{ margin:22px 0 10px; font-weight:800; font-size:18px; letter-spacing:0.2px; }

.tiers{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:12px;
  margin:12px auto 10px;
}
@media (max-width: 720px){ .tiers{ grid-template-columns: 1fr; } }

.tier{
  text-align:left;
  padding:16px;
  border-radius:16px;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
  box-shadow: 0 12px 40px rgba(0,0,0,0.35);
  position:relative;
  overflow:hidden;
}
.tier:before{ content:""; position:absolute; inset:-2px; opacity:0.9; pointer-events:none; }
.tier.basic:before{ background: radial-gradient(550px 250px at 30% 20%, rgba(77,163,255,0.22), transparent 60%); }
.tier.vip:before{ background: radial-gradient(550px 250px at 30% 20%, rgba(56,214,107,0.22), transparent 60%); }
.tier.elite:before{ background: radial-gradient(550px 250px at 30% 20%, rgba(255,207,74,0.20), transparent 60%); }
.tier > *{ position:relative; z-index:1; }
.tier h3{ margin:2px 0 6px; font-size:20px; }
.tier p{ margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.35; }

.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  font-weight:800;
  padding:8px 10px;
  border-radius:999px;
  margin-bottom:10px;
  border:1px solid rgba(255,255,255,0.16);
  background: rgba(0,0,0,0.25);
}
.pill.basic{ color: var(--blue); border-color: rgba(77,163,255,0.35); }
.pill.vip{ color: var(--green); border-color: rgba(56,214,107,0.35); }
.pill.elite{ color: var(--gold); border-color: rgba(255,207,74,0.35); }

.buy-btn{
  width:100%;
  border:none;
  border-radius:14px;
  padding:14px 14px;
  font-size:16px;
  font-weight:900;
  cursor:pointer;
  color:#0b0b0b;
  margin-top:6px;
  transition: transform .12s ease, filter .12s ease;
}
.buy-btn:active{ transform: scale(0.98); filter:brightness(0.95); }
.buy-basic{ background: linear-gradient(90deg, rgba(77,163,255,0.95), rgba(77,163,255,0.75)); }
.buy-vip{ background: linear-gradient(90deg, rgba(56,214,107,0.95), rgba(56,214,107,0.75)); }
.buy-elite{ background: linear-gradient(90deg, rgba(255,207,74,0.98), rgba(255,207,74,0.75)); }

.small-note{ margin-top:10px; color:var(--muted); font-size:12px; }

/* MODALS */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.92);
  backdrop-filter: blur(14px);
  overflow:auto;
  padding:18px 12px 90px;
  z-index:9999;
}
.modal-card{
  max-width:560px;
  margin:20px auto;
  background:#0f1117;
  border: 1px solid rgba(255,255,255,0.10);
  border-radius:18px;
  padding:20px;
  box-shadow: 0 40px 120px rgba(0,0,0,0.9);
  text-align:left;
  position:relative;
  overflow:hidden;
}
.modal-card::before{
  content:"";
  position:absolute;
  top:0; left:0; right:0;
  height:3px;
  background: linear-gradient(90deg, #38d66b, #4da3ff, #b46bff);
  border-radius: 18px 18px 0 0;
}
.modal-card h2{ margin:6px 0 12px; text-align:center; position:relative; z-index:1; }

.field{
  width:100%;
  padding:12px 12px;
  margin:8px 0;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.16);
  background:#151822;
  color:var(--text);
  outline:none;
  position:relative;
  z-index:1;
}
.field::placeholder{ color: rgba(255,255,255,0.55); }

.row{ display:flex; gap:10px; position:relative; z-index:1; }
@media(max-width:560px){ .row{ flex-direction:column; } }

.modal-actions{
  display:flex;
  gap:10px;
  margin-top:12px;
  position:relative;
  z-index:1;
}
.action{
  flex:1;
  border:none;
  border-radius:14px;
  padding:14px 14px;
  font-size:15px;
  font-weight:900;
  cursor:pointer;
}
.action.submit{
  background: linear-gradient(90deg, var(--green), rgba(56,214,107,0.7));
  color:#07160c;
}
.action.cancel{
  background: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.20);
  color: var(--text);
}

hr.sep{ border:none; border-top:1px solid rgba(255,255,255,0.10); margin:12px 0; }

/* ADMIN BAR */
.admin-bar{
  position:fixed;
  bottom:0; left:0; right:0;
  background: rgba(10,10,16,0.85);
  backdrop-filter: blur(10px);
  border-top:1px solid rgba(255,255,255,0.12);
  padding:10px 10px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  z-index:99999;
}
.admin-bar input{
  width:min(520px, 65%);
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.08);
  color: var(--text);
}
.admin-bar button{
  padding:12px 14px;
  border-radius:12px;
  border:none;
  font-weight:900;
  cursor:pointer;
  background: linear-gradient(90deg, var(--purple), var(--blue));
  color:white;
}

/* ADMIN cards */
.admin-card{ margin-top:14px; padding:14px; border-radius:16px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); backdrop-filter: blur(14px); }
.admin-card-title{ font-weight:900; margin-bottom:10px; }
.admin-row{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
.admin-input{ flex:1; min-width:120px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.35); color:#fff; }
.admin-btn{ padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.10); color:#fff; font-weight:900; cursor:pointer; }
.admin-btn.wide{ width:100%; }

.table-card{
  margin:10px 0;
  padding:14px;
  border-radius:14px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
}
.table-card strong{ font-size:14px; }
.kv{ color: var(--muted); font-size:12px; line-height:1.45; margin-top:6px; }
.kv b{ color: var(--text); }

.admin-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
}
.admin-actions button{
  flex:1;
  min-width: 160px;
  border:none;
  border-radius:12px;
  padding:10px;
  font-weight:900;
  cursor:pointer;
}
.btn-used{ background: rgba(56,214,107,0.18); border:1px solid rgba(56,214,107,0.35); color: var(--text); }
.btn-warn{ background: rgba(255,207,74,0.14); border:1px solid rgba(255,207,74,0.35); color: var(--text); }
.btn-reset{ background: rgba(255,59,59,0.14); border:1px solid rgba(255,59,59,0.35); color: var(--text); }
.btn-blue{ background: rgba(77,163,255,0.16); border:1px solid rgba(77,163,255,0.35); color: var(--text); }

.checkboxRow{ display:flex; gap:10px; align-items:flex-start; margin-top:6px; text-align:left; color: rgba(255,255,255,0.8); font-size:12px; line-height:1.35; }
.checkboxRow input{ margin-top:2px; }

/* MENU */
.menu-btn{
  margin: 10px auto 12px;
  border:none;
  border-radius:14px;
  padding:14px 16px;
  font-size:16px;
  font-weight:900;
  cursor:pointer;
  width:min(360px, 92%);
  color: var(--text);
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.16);
  backdrop-filter: blur(10px);
  box-shadow: 0 14px 50px rgba(0,0,0,0.45);
  transition: transform .12s ease, filter .12s ease;
}
.menu-btn:active{ transform: scale(0.98); filter: brightness(0.95); }

.menu-panel{
  display:none;
  width:min(540px, 92%);
  margin: 0 auto 14px;
  border-radius:18px;
  position:relative;
  overflow:hidden;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(255,255,255,0.14);
  backdrop-filter: blur(14px);
  box-shadow: 0 18px 70px rgba(0,0,0,0.55);
}
.menu-inner{ position:relative; z-index:2; padding:18px; text-align:left; }
.menu-title{ font-size:18px; font-weight:900; letter-spacing:0.2px; }
.menu-sub{ color: rgba(255,255,255,0.7); font-size:12px; margin-top:4px; }

.menu-deal{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  background: rgba(56,214,107,0.12);
  border:1px solid rgba(56,214,107,0.28);
  font-weight:800;
  font-size:13px;
}
.menu-section{
  margin-top:14px;
  padding:12px;
  border-radius:16px;
  background: rgba(0,0,0,0.28);
  border: 1px solid rgba(255,255,255,0.10);
}
.menu-h{ font-weight:900; letter-spacing:0.2px; margin-bottom:8px; font-size:14px; }
.menu-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 0;
  border-top:1px solid rgba(255,255,255,0.08);
  font-size:13px;
  color: rgba(255,255,255,0.86);
}
.menu-item:first-of-type{ border-top:none; }
.menu-item b{ color:white; font-weight:900; }

.menu-close{
  margin-top:14px;
  width:100%;
  border:none;
  border-radius:14px;
  padding:12px 12px;
  font-weight:900;
  cursor:pointer;
  color: var(--text);
  background: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.18);
}

.request-btn{
  margin-top:14px;
  width:100%;
  border:none;
  border-radius:14px;
  padding:12px 12px;
  font-weight:900;
  cursor:pointer;
  color: var(--text);
  background: rgba(255, 214, 0, 0.14);
  border: 1px solid rgba(255, 214, 0, 0.30);
}

/* Request mini modal */
.mini-modal{
  display:none;
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.78);
  backdrop-filter: blur(10px);
  z-index: 20000;
  padding: 16px;
}
.mini-card{
  width:min(520px, 92%);
  margin: 8vh auto;
  border-radius:18px;
  padding:16px;
  background:#0f1117;
  border: 1px solid rgba(255,255,255,0.serif;
  box-shadow: 0 18px 70px rgba(0,0,0,0.75);
  color:#fff;
}
.mini-actions{ display:flex; gap:10px; margin-top:12px; }
.mini-actions button{
  flex:1;
  border:none;
  border-radius:14px;
  padding:12px;
  font-weight:900;
  cursor:pointer;
  color:#fff;
  background: rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.18);
}

/* Stars */
.menu-stars{ position:absolute; inset:0; z-index:1; pointer-events:none; opacity:0.55; }
.menu-stars::before,
.menu-stars::after{
  content:"";
  position:absolute;
  inset:-80px 0 0 0;
  background-repeat: repeat;
}
.menu-stars::before{
  background-image:
    radial-gradient(circle, rgba(255,255,255,0.9) 1px, transparent 1.6px),
    radial-gradient(circle, rgba(255,255,255,0.6) 1px, transparent 1.8px);
  background-size: 110px 140px, 170px 210px;
  background-position: 0 0, 40px 60px;
  animation: starsFall 16s linear infinite, starsTwinkle 2.8s ease-in-out infinite;
}
.menu-stars::after{
  background-image:
    radial-gradient(circle, rgba(255,255,255,0.75) 1.2px, transparent 2.2px),
    radial-gradient(circle, rgba(255,207,74,0.25) 1.4px, transparent 2.6px);
  background-size: 220px 260px, 300px 340px;
  background-position: 20px 20px, 100px 120px;
  animation: starsFall 28s linear infinite, starsTwinkle2 4.2s ease-in-out infinite;
  opacity:0.6;
}
@keyframes starsFall{ from { transform: translateY(-60px);} to { transform: translateY(260px);} }
@keyframes starsTwinkle{ 0%,100% { opacity: 0.55; } 50% { opacity: 0.92; } }
@keyframes starsTwinkle2{ 0%,100% { opacity: 0.35; } 50% { opacity: 0.70; } }

/* Admin ticker / profit */
.admin-ticker{
  margin-top:12px;
  padding:10px 12px;
  border-radius:14px;
  background: rgba(255, 214, 0, 0.12);
  border: 1px solid rgba(255, 214, 0, 0.28);
  font-weight:900;
  white-space:nowrap;
  overflow:hidden;
}
.admin-ticker::after{
  content: attr(data-text);
  display:inline-block;
  padding-left: 40px;
  animation: tickerScroll 12s linear infinite;
}
@keyframes tickerScroll{ from{ transform: translateX(0); } to{ transform: translateX(-60%); } }

.profit-top{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:10px; }
.profit-ticker{ font-size:28px; font-weight:1000; }
.profit-meta{ opacity:.75; font-size:12px; }

.daily-target{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  background: rgba(56,214,107,0.10);
  border: 1px solid rgba(56,214,107,0.18);
  font-weight:900;
}

.split-row{
  display:flex;
  gap:12px;
  margin-top:10px;
  flex-wrap:wrap;
}
.split-box{
  flex:1;
  min-width:220px;
  padding:12px;
  border-radius:14px;
  background: rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
}
.split-title{ font-weight:900; opacity:.9; }
.split-amt{ font-weight:1000; font-size:22px; margin-top:6px; }
.split-sub{ opacity:.7; font-size:12px; margin-top:6px; }

.tabs{ display:flex; gap:8px; flex-wrap:wrap; }
.tab{ padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.28); color:#fff; font-weight:900; cursor:pointer; }
.tabpanel{ display:none; margin-top:12px; }

/* Dropdown panel */
.dropdown-btn{
  width:100%;
  border:none;
  border-radius:14px;
  padding:12px 12px;
  font-weight:900;
  cursor:pointer;
  color: var(--text);
  background: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.18);
}
</style>
</head>

<body>

<!-- Logo -->
<div class="brand-logo" onclick="location.reload()">
  <span>jack-on-the-go</span>
</div>

<!-- Toast -->
<div id="toast" class="toast">welcome</div>

<div class="container">
  <div class="hero-card">
    <div class="h1">üî• THIS WEEK'S DROP</div>

    <div class="timer">
      ‚è≥ <span id="timer">10:00</span>
      <small>ends soon</small>
    </div>

    <div class="badge-row">
      <div class="badge hot pulse">‚ö° Limited spots</div>
      <div class="badge cancel">‚úÖ Cancel anytime</div>
      <div class="badge">üîí Secret drops for Elite</div>
    </div>

    <div class="sub">
      Pick a club. Grab your spot. Get restock texts if you want. No lock-in.
    </div>

    <button class="primary-btn" onclick="scrollToClubs()">View Clubs</button>
    <div class="small-note">Cancel anytime = stop whenever you want. No stress.</div>
  </div>

  <div id="clubs"></div>

  <button class="menu-btn" onclick="toggleMenu()">üç¨ Menu</button>

  <div id="menuPanel" class="menu-panel">
    <div class="menu-stars"></div>
    <div class="menu-inner">
      <div class="menu-title">SNACK MENU</div>
      <div class="menu-sub">Drinks ‚Ä¢ Snacks ‚Ä¢ Gum</div>

      <div class="menu-deal">ü•§ Drinks Deal: <b>Buy 2 get 1 free</b></div>

      <!-- dynamic menu goes here -->
      <div id="menuContent"></div>

      <button class="request-btn" onclick="openRequest()">‚ûï Request an item</button>
      <button class="menu-close" onclick="toggleMenu(false)">Close</button>
    </div>
  </div>

  <div class="section-title">Choose your club</div>

  <div class="tiers">
    <div class="tier basic">
      <div class="pill basic">üßä BASIC ‚Ä¢ Trust</div>
      <h3>Basic</h3>
      <p>First access + guaranteed spot in the lineup.</p>
      <button class="buy-btn buy-basic" onclick="pickTier('Basic')">Claim Basic</button>
    </div>

    <div class="tier vip">
      <div class="pill vip">üí∏ VIP ‚Ä¢ Best Value</div>
      <h3>VIP</h3>
      <p>First access + VIP line + weekly free treat.</p>
      <button class="buy-btn buy-vip" onclick="pickTier('VIP')">Claim VIP</button>
    </div>

    <div class="tier elite">
      <div class="pill elite">üèÜ ELITE 25 ‚Ä¢ Status</div>
      <h3>Elite 25</h3>
      <p>Everything in VIP + priority + secret drops.</p>
      <button class="buy-btn buy-elite" onclick="pickTier('Elite 25')">Claim Elite 25</button>
    </div>
  </div>

  <div class="small-note">
    This page stores signups on THIS device (localStorage). For cross-phone sync, you‚Äôll want Google Sheets/Supabase later.
  </div>
</div>

<!-- Request Modal -->
<div id="requestModal" class="mini-modal">
  <div class="mini-card">
    <h3 style="margin:0 0 10px;">Request an item</h3>
    <p style="opacity:.75; margin:0 0 10px;">Type what you want added. If 5+ people request the same thing, admin will see it.</p>
    <input id="requestInput" type="text" placeholder="ex: Takis, Dr Pepper, Gatorade..." class="field" />
    <div class="mini-actions">
      <button onclick="submitRequest()">Submit</button>
      <button onclick="closeRequest()">Cancel</button>
    </div>
  </div>
</div>

<!-- Signup Modal -->
<div id="signupModal" class="modal">
  <div class="modal-card">
    <h2 id="signupTitle">Join</h2>
    <div class="small-note" style="text-align:center;margin-bottom:8px;">
      ‚úÖ Cancel anytime ‚Ä¢ takes 10 seconds
    </div>

    <div class="row">
      <input class="field" id="firstName" placeholder="First Name">
      <input class="field" id="lastName" placeholder="Last Name">
    </div>

    <input class="field" id="phone" placeholder="Phone Number (optional) e.g. 8015551234" inputmode="tel">

    <div class="checkboxRow">
      <input type="checkbox" id="smsConsent">
      <div>
        Yes ‚Äî text me restocks + secret drops + ‚Äústock up‚Äù alerts. Reply <b>STOP</b> to opt out.
      </div>
    </div>

    <div class="row">
      <select class="field" id="lunch">
        <option value="">Select Lunch</option>
        <option value="A">A Lunch</option>
        <option value="B">B Lunch</option>
      </select>

      <select class="field" id="timePref" onchange="checkOther()">
        <option value="">When do you buy?</option>
        <option value="Lunch">Lunch</option>
        <option value="Before School">Before School</option>
        <option value="After School">After School</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <input class="field" id="otherField" placeholder="If Other: class + period (ex: Biology 3rd)" style="display:none;">

    <div class="modal-actions">
      <button class="action submit" onclick="submitSignup()">Submit</button>
      <button class="action cancel" onclick="closeSignup()">Cancel</button>
    </div>
  </div>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="modal">
  <div class="modal-card">
    <h2>Admin Dashboard</h2>
    <div class="small-note" style="text-align:center;">
      Track signups, due dates, expired, and perk usage.
    </div>

    <div class="modal-actions" style="margin-top:10px;">
      <button class="action submit" onclick="openTextModal()">Send Out Text</button>
      <button class="action cancel" onclick="exportCSV()">Export Signups CSV</button>
    </div>

    <div id="adminTicker" class="admin-ticker" style="display:none;"></div>

    <!-- Menu management -->
    <div class="admin-card">
      <div class="admin-card-title">Menu Item Manager (add / delete / edit sell price)</div>

      <div class="admin-row">
        <input id="newItemName" class="admin-input" placeholder="Item name (ex: Takis)" />
        <select id="newItemCat" class="admin-input">
          <option value="Energy">Energy</option>
          <option value="Soda">Soda</option>
          <option value="Snacks">Snacks</option>
          <option value="Gum">Gum</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="admin-row">
        <input id="newItemSell" class="admin-input" type="number" step="0.01" placeholder="Sell price (ex: 4.50)" />
        <input id="newItemUnits" class="admin-input" type="number" step="1" placeholder="Bulk units (ex: 24)" />
        <input id="newItemCost" class="admin-input" type="number" step="0.01" placeholder="Bulk cost (ex: 48.67)" />
      </div>

      <button class="admin-btn wide" onclick="addMenuItem()">Add Item</button>

      <div style="margin-top:12px; opacity:.75; font-size:12px;">
        Tip: ‚ÄúBulk units + bulk cost‚Äù lets profit math work instantly. You can edit anytime.
      </div>

      <div id="itemList" style="margin-top:12px;"></div>
    </div>

    <!-- Sales entry -->
    <div class="admin-card">
      <div class="admin-card-title">Record a sale</div>
      <div class="admin-row">
        <select id="saleItem" class="admin-input"></select>
        <input id="saleQty" class="admin-input" type="number" min="1" value="1" />
        <button class="admin-btn" onclick="recordSale()">Buy</button>
      </div>
      <div class="admin-row">
        <input id="saleNote" class="admin-input" placeholder="optional note (who/where)" />
      </div>
    </div>

    <!-- Profit -->
    <div class="admin-card">
      <div class="admin-card-title">Profit Tracker</div>
      <div class="profit-top">
        <div class="profit-ticker" id="profitTicker">$0.00</div>
        <div class="profit-meta" id="profitMeta">Today: $0 ‚Ä¢ Week: $0</div>
      </div>
      <canvas id="profitChart" height="140"></canvas>
      <div class="daily-target" id="dailyTarget">Today‚Äôs target: ‚Äî</div>
    </div>

    <!-- Split profits 50/50 -->
    <div class="admin-card">
      <div class="admin-card-title">Weekly Profit Split (50/50)</div>
      <div class="split-row">
        <div class="split-box">
          <div class="split-title">Riley‚Äôs Weekly Profit</div>
          <div class="split-amt" id="rileyWeekly">$0.00</div>
          <div class="split-sub">Half of weekly profit</div>
        </div>
        <div class="split-box">
          <div class="split-title">Jackson‚Äôs Weekly Profit</div>
          <div class="split-amt" id="jacksonWeekly">$0.00</div>
          <div class="split-sub">Half of weekly profit</div>
        </div>
      </div>
    </div>

    <!-- Analytics -->
    <div class="admin-card">
      <button class="admin-btn wide" onclick="toggleAnalytics()">üìä Analytics (open/close)</button>
      <div id="analyticsPanel" style="display:none; margin-top:12px;">
        <div class="tabs">
          <button class="tab" onclick="showTab('mrr')">MRR Waterfall</button>
          <button class="tab" onclick="showTab('nrr')">NRR</button>
          <button class="tab" onclick="showTab('growth')">Cumulative ARR/MRR</button>
          <button class="tab" onclick="showTab('hot')">HOT Items</button>
        </div>
        <div class="tabpanel" id="tab-mrr"><canvas id="mrrChart" height="160"></canvas></div>
        <div class="tabpanel" id="tab-nrr"><canvas id="nrrChart" height="160"></canvas></div>
        <div class="tabpanel" id="tab-growth"><canvas id="growthChart" height="160"></canvas></div>
        <div class="tabpanel" id="tab-hot"><canvas id="hotChart" height="160"></canvas></div>
      </div>
    </div>

    <!-- Cost Settings dropdown -->
    <div class="admin-card">
      <button class="dropdown-btn" onclick="toggleCosts()">üßæ Cost Settings (open/close)</button>
      <div id="costsPanel" style="display:none; margin-top:12px;">
        <div class="admin-card-title">Edit costs + units + sell price</div>
        <p style="opacity:.75; margin:0 0 10px;">Profit uses revenue ‚àí cost. Edit bulk cost + units to get accurate unit cost.</p>
        <div id="costEditor"></div>
        <button class="admin-btn wide" onclick="saveCosts()">Save All Pricing</button>
      </div>
    </div>

    <hr class="sep">
    <div id="adminData"></div>

    <div class="modal-actions">
      <button class="action cancel" onclick="closeAdmin()">Close</button>
      <button class="action submit" onclick="wipeAll()">Wipe Device Data</button>
    </div>
  </div>
</div>

<!-- Text Modal -->
<div id="textModal" class="modal">
  <div class="modal-card">
    <h2>Send Out Text</h2>
    <div class="small-note" style="text-align:center;">
      Generates CSV (phone, message). No auto-sending in this version.
    </div>

    <select class="field" id="textType" onchange="toggleItemField()">
      <option value="new_stock">New stock</option>
      <option value="leaving_soon">Stock leaving soon</option>
      <option value="new_item">New item (type item name)</option>
      <option value="secret_drop">Secret drop (Elite only)</option>
    </select>

    <input class="field" id="itemName" placeholder="Item name (e.g., Sour Punch Bites)" style="display:none;">

    <select class="field" id="audience">
      <option value="all">Audience: All (with consent)</option>
      <option value="vip_plus">Audience: VIP + Elite</option>
      <option value="elite_only">Audience: Elite only</option>
    </select>

    <div class="modal-actions">
      <button class="action submit" onclick="generateTextCSV()">Generate CSV</button>
      <button class="action cancel" onclick="closeTextModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Admin bar -->
<div class="admin-bar" id="adminBar">
  <input id="adminCode" placeholder="Admin Code">
  <button onclick="adminLogin()">Login</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/*** CONFIG ***/
const ADMIN_USERS = {
  "1234": { name: "Jackson", color: "#6dff9a" },
  "5678": { name: "Riley",   color: "#6dff9a" }
};
const SUB_LENGTH_DAYS = 7;
let selectedTier = null;

/*** TIERS + PERKS ***/
const perksByTier = {
  "Basic":    { firstAccess: true },
  "VIP":      { firstAccess: true, weeklyFreeTreat: true, vipLine: true },
  "Elite 25": { firstAccess: true, weeklyFreeTreat: true, vipLine: true, secretDrops: true, priority: true }
};

/*** TIMER ***/
let countdown = 600;
const timerEl = document.getElementById("timer");
setInterval(()=>{
  let m = Math.floor(countdown/60);
  let s = countdown%60;
  timerEl.textContent = `${m}:${s<10?'0'+s:s}`;
  countdown = Math.max(0, countdown-1);
},1000);

function scrollToClubs(){ document.getElementById("clubs").scrollIntoView({behavior:"smooth"}); }

/*** MENU ***/
function toggleMenu(force){
  const panel = document.getElementById("menuPanel");
  const showIt = (typeof force === "boolean") ? force : (panel.style.display !== "block");
  panel.style.display = showIt ? "block" : "none";
}

/*** MODALS ***/
function show(elId){ document.getElementById(elId).style.display = "block"; }
function hide(elId){ document.getElementById(elId).style.display = "none"; }

/*** Toast welcome ***/
function showWelcome(name){
  const t = document.getElementById("toast");
  t.textContent = `welcome ${name.toLowerCase()}`;
  t.classList.remove("fade");
  t.classList.add("show");
  setTimeout(()=>{
    t.classList.add("fade");
    setTimeout(()=> t.classList.remove("show"), 1200);
  }, 3000);
}

/*** Request modal ***/
function openRequest(){ document.getElementById("requestModal").style.display = "block"; }
function closeRequest(){ document.getElementById("requestModal").style.display = "none"; }

function normItem(s){
  return (s||"").toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g," ").trim();
}
function getRequests(){ return JSON.parse(localStorage.getItem("itemRequests")||"[]"); }
function setRequests(x){ localStorage.setItem("itemRequests", JSON.stringify(x)); }
function submitRequest(){
  const raw = document.getElementById("requestInput").value;
  const n = normItem(raw);
  if(!n){ alert("Type an item first"); return; }
  const reqs = getRequests();
  reqs.push({ raw, n, ts: Date.now() });
  setRequests(reqs);
  document.getElementById("requestInput").value="";
  closeRequest();
  alert("Request submitted üëÄ");
}

/*** SIGNUP FLOW ***/
function pickTier(tier){
  selectedTier = tier;
  document.getElementById("signupTitle").innerText = `Join ${tier}`;
  show("signupModal");
}
function closeSignup(){ hide("signupModal"); }
function checkOther(){
  const v = document.getElementById("timePref").value;
  document.getElementById("otherField").style.display = (v === "Other") ? "block" : "none";
}
function submitSignup(){
  const first = document.getElementById("firstName").value.trim();
  const last  = document.getElementById("lastName").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const smsConsent = document.getElementById("smsConsent").checked;
  const lunch = document.getElementById("lunch").value;
  const time  = document.getElementById("timePref").value;
  const other = document.getElementById("otherField").value.trim();

  if(!selectedTier){ alert("Pick a club first."); return; }
  if(!first || !last){ alert("Add first + last name."); return; }
  if(!lunch){ alert("Select A or B lunch."); return; }
  if(!time){ alert("Select when you buy."); return; }
  if(time === "Other" && !other){ alert("Type the class + period."); return; }
  if(phone && !smsConsent){
    alert('To get texts, check the consent box (you can opt out anytime by replying "STOP").');
    return;
  }

  const joined = new Date();
  const due = new Date(joined.getTime() + SUB_LENGTH_DAYS*24*60*60*1000);

  const data = {
    id: cryptoId(),
    tier: selectedTier,
    first, last,
    phone,
    smsConsent,
    lunch,
    time,
    other: (time === "Other") ? other : "",
    joinedISO: joined.toISOString(),
    dueISO: due.toISOString(),
    cancelled: false,
    cancelledAtISO: "",
    smsOptedOut: false,
    perks: perksByTier[selectedTier],
    perksUsed: { weeklyFreeTreat:false, vipLine:false, secretDrops:false, priority:false }
  };

  const users = loadUsers();
  users.push(data);
  saveUsers(users);

  alert(`You're in ‚úÖ\n${selectedTier}\nCancel anytime.`);
  closeSignup();
  resetFormFields();
}

function resetFormFields(){
  document.getElementById("firstName").value="";
  document.getElementById("lastName").value="";
  document.getElementById("phone").value="";
  document.getElementById("smsConsent").checked=false;
  document.getElementById("lunch").value="";
  document.getElementById("timePref").value="";
  document.getElementById("otherField").value="";
  document.getElementById("otherField").style.display="none";
}

function randomHookLine(name){
  const hooks = [
    "Click before we sell out",
    "You‚Äôve been chosen",
    "Your access just unlocked",
    "Don‚Äôt miss this week‚Äôs drop",
    "VIP eyes only (for now)",
    "Lowkey‚Ä¶ this one disappears fast"
  ];
  const pick = hooks[Math.floor(Math.random()*hooks.length)];
  return `${name} ‚Äî ${pick}.`;
}

/*** STORAGE ***/
function loadUsers(){ return JSON.parse(localStorage.getItem("drop_users") || "[]"); }
function saveUsers(users){ localStorage.setItem("drop_users", JSON.stringify(users)); }
function cryptoId(){ return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }

/*** ADMIN ***/
function adminLogin(){
  const code = document.getElementById("adminCode").value.trim();
  const who = ADMIN_USERS[code];
  if(who){
    document.getElementById("adminBar").style.display = "none";
    showWelcome(who.name);
    loadAdmin();
    show("adminPanel");
    refreshAllAdmin();
  } else {
    alert("Wrong code.");
  }
}
function closeAdmin(){
  hide("adminPanel");
  document.getElementById("adminBar").style.display = "flex";
}

function isExpired(u){
  if(u.cancelled) return true;
  return new Date() > new Date(u.dueISO);
}
function fmt(ts){ try { return new Date(ts).toLocaleString(); } catch(e){ return ""; } }

function loadAdmin(){
  const users = loadUsers();
  if(users.length === 0){
    document.getElementById("adminData").innerHTML = `<div class="table-card">No signups yet.</div>`;
    return;
  }
  let html = "";
  users.forEach((u)=>{
    const expired = isExpired(u);
    const status = expired ? "Expired" : "Active";
    const statusColor = expired ? "rgba(255,59,59,0.95)" : "rgba(56,214,107,0.95)";
    const buyTime = u.time + (u.other ? ` (${u.other})` : "");
    const canSMS = !!(u.phone && u.smsConsent && !u.smsOptedOut);

    html += `
      <div class="table-card">
        <strong>${escapeHtml(u.first)} ${escapeHtml(u.last)}</strong>
        <div class="kv">
          Tier: <b>${escapeHtml(u.tier)}</b><br>
          Lunch: <b>${escapeHtml(u.lunch)}</b><br>
          Buy time: <b>${escapeHtml(buyTime)}</b><br>
          Joined: <b>${escapeHtml(fmt(u.joinedISO))}</b><br>
          Due: <b>${escapeHtml(fmt(u.dueISO))}</b><br>
          Status: <b style="color:${statusColor}">${status}</b><br>
          Phone: <b>${u.phone ? escapeHtml(u.phone) : "‚Äî"}</b><br>
          SMS Eligible: <b>${canSMS ? "Yes" : "No"}</b>
        </div>
      </div>
    `;
  });
  document.getElementById("adminData").innerHTML = html;
}

function wipeAll(){
  const ok = confirm("Wipe ALL device data? (signups + items + sales)");
  if(!ok) return;
  localStorage.removeItem("drop_users");
  localStorage.removeItem("itemsCatalog");
  localStorage.removeItem("salesLog");
  localStorage.removeItem("itemRequests");
  items = loadItems();
  refreshAllAdmin();
}

/*** TEXT MODAL (simple) ***/
function openTextModal(){ show("textModal"); }
function closeTextModal(){ hide("textModal"); }
function toggleItemField(){
  const t = document.getElementById("textType").value;
  document.getElementById("itemName").style.display = (t === "new_item") ? "block" : "none";
}
function generateTextCSV(){
  alert("Text CSV generator is still available ‚Äî add back if you want the full SMS builder version.");
  closeTextModal();
}
function exportCSV(){
  const users = loadUsers();
  const headers = ["Tier","First","Last","Phone","SMSConsent","Lunch","BuyTime","Other","Joined","Due","Expired","Cancelled"];
  const rows = users.map(u=>[
    u.tier, u.first, u.last, u.phone || "", u.smsConsent ? "Yes":"No",
    u.lunch, u.time, u.other || "", u.joinedISO, u.dueISO,
    isExpired(u) ? "Yes":"No",
    u.cancelled ? "Yes":"No"
  ]);
  const csv = [headers, ...rows].map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
  downloadFile("drop_signups.csv", csv, "text/csv");
}

/*** Utilities ***/
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function downloadFile(filename, content, type){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ===== Items + profit system ===== */
/* Items now include category so menu can render dynamically */
const DEFAULT_ITEMS = [
  { key:"redbull_original", name:"Redbull (original)", cat:"Energy", sell:4.50, units:24, cost:48.67 },
  { key:"redbull_red", name:"Redbull (red)", cat:"Energy", sell:4.95, units:24, cost:63.00 },
  { key:"monster_white", name:"Monster (white)", cat:"Energy", sell:6.00, units:24, cost:42.48 },

  { key:"coke", name:"Coke (original)", cat:"Soda", sell:3.00, units:24, cost:14.77 },
  { key:"fanta", name:"Fanta (original)", cat:"Soda", sell:3.75, units:24, cost:14.77 },
  { key:"mtndew", name:"Mtn Dew (original)", cat:"Soda", sell:5.00, units:24, cost:12.48 },

  { key:"doritos_nacho", name:"Doritos (nacho)", cat:"Snacks", sell:3.75, units:40, cost:19.20 },
  { key:"doritos_blue", name:"Doritos (blue)", cat:"Snacks", sell:4.25, units:40, cost:19.20 },
  { key:"funyun", name:"Funyun", cat:"Snacks", sell:4.90, units:40, cost:13.45 },
  { key:"hot_cheetos", name:"Hot Cheetos", cat:"Snacks", sell:5.00, units:40, cost:31.80 },

  { key:"spearmint", name:"Spearmint", cat:"Gum", sell:3.00, units:40, cost:18.99 },
  { key:"hubba", name:"Hubba Bubba", cat:"Gum", sell:3.75, units:12, cost:11.49 },
  { key:"ice_breakers", name:"Ice Breakers Cube", cat:"Gum", sell:6.00, units:100, cost:8.37 },
];

function loadItems(){
  const saved = localStorage.getItem("itemsCatalog");
  return saved ? JSON.parse(saved) : DEFAULT_ITEMS;
}
function saveItems(items){ localStorage.setItem("itemsCatalog", JSON.stringify(items)); }

function loadSales(){ return JSON.parse(localStorage.getItem("salesLog")||"[]"); }
function saveSales(sales){ localStorage.setItem("salesLog", JSON.stringify(sales)); }

let items = loadItems();
let charts = {};

function money(x){ return (x||0).toLocaleString(undefined,{style:"currency",currency:"USD"}); }
function unitCost(item){ return (item.units ? (item.cost / item.units) : 0); }

/* Render menu from items */
function renderMenu(){
  const wrap = document.getElementById("menuContent");
  if(!wrap) return;
  const cats = ["Energy","Soda","Snacks","Gum","Other"];
  const groups = {};
  for(const c of cats) groups[c] = [];
  for(const it of items){
    const c = it.cat || "Other";
    if(!groups[c]) groups[c] = [];
    groups[c].push(it);
  }
  let html = "";
  for(const c of cats){
    const list = groups[c] || [];
    if(list.length === 0) continue;
    html += `<div class="menu-section"><div class="menu-h">${c === "Energy" ? "‚ö° Energy" : c === "Soda" ? "ü•§ Soda" : c === "Snacks" ? "üî• Snacks" : c === "Gum" ? "üßä Gum" : "‚ú® Other"}</div>`;
    for(const it of list){
      html += `<div class="menu-item"><span>${escapeHtml(it.name)}</span><b>${money(it.sell)}</b></div>`;
    }
    html += `</div>`;
  }
  wrap.innerHTML = html;
}

/* Admin: add/delete/edit sell price */
function renderItemList(){
  const el = document.getElementById("itemList");
  if(!el) return;

  const rows = items.map(it => `
    <div class="table-card">
      <strong>${escapeHtml(it.name)}</strong>
      <div class="kv">
        Category: <b>${escapeHtml(it.cat || "Other")}</b><br>
        Sell: <b>${money(it.sell)}</b> ‚Ä¢ Unit cost: <b>${money(unitCost(it))}</b> ‚Ä¢ Margin: <b>${money(it.sell - unitCost(it))}</b>
      </div>
      <div class="admin-row">
        <input class="admin-input" type="number" step="0.01" value="${it.sell}" id="sell_${it.key}" />
        <button class="admin-btn" onclick="saveSell('${it.key}')">Save Sell</button>
        <button class="admin-btn" style="border-color:rgba(255,59,59,0.35); background:rgba(255,59,59,0.14);" onclick="deleteItem('${it.key}')">Delete</button>
      </div>
    </div>
  `).join("");

  el.innerHTML = rows || `<div class="table-card">No items.</div>`;
}

function saveSell(key){
  const v = parseFloat(document.getElementById(`sell_${key}`).value || "0");
  items = items.map(it => it.key === key ? ({...it, sell: v}) : it);
  saveItems(items);
  refreshAllAdmin();
}

function addMenuItem(){
  const name = (document.getElementById("newItemName").value||"").trim();
  const cat  = document.getElementById("newItemCat").value;
  const sell = parseFloat(document.getElementById("newItemSell").value||"0");
  const units= parseFloat(document.getElementById("newItemUnits").value||"0");
  const cost = parseFloat(document.getElementById("newItemCost").value||"0");

  if(!name){ alert("Add item name"); return; }
  if(!sell || sell <= 0){ alert("Add sell price"); return; }
  if(!units || units <= 0){ alert("Add bulk units"); return; }
  if(!cost || cost < 0){ alert("Add bulk cost"); return; }

  const key = "k_" + normItem(name).replace(/\s/g,"_") + "_" + Date.now();
  items.push({ key, name, cat, sell, units, cost });
  saveItems(items);

  document.getElementById("newItemName").value="";
  document.getElementById("newItemSell").value="";
  document.getElementById("newItemUnits").value="";
  document.getElementById("newItemCost").value="";

  refreshAllAdmin();
}

function deleteItem(key){
  const ok = confirm("Delete this item? (sales history will remain)");
  if(!ok) return;
  items = items.filter(it => it.key !== key);
  saveItems(items);
  refreshAllAdmin();
}

/* Cost settings dropdown */
function toggleCosts(){
  const p = document.getElementById("costsPanel");
  p.style.display = (p.style.display === "none" || !p.style.display) ? "block" : "none";
}

/* Cost editor now also edits SELL */
function renderCostEditor(){
  const wrap = document.getElementById("costEditor");
  if(!wrap) return;
  wrap.innerHTML = items.map(i => `
    <div style="display:grid; grid-template-columns: 1.5fr .7fr .7fr .7fr; gap:10px; margin-top:10px;">
      <div class="admin-input" style="display:flex; align-items:center;">${escapeHtml(i.name)}</div>
      <input class="admin-input" type="number" step="0.01" id="sellE_${i.key}" value="${i.sell}">
      <input class="admin-input" type="number" step="0.01" id="cost_${i.key}" value="${i.cost}">
      <input class="admin-input" type="number" step="1" id="units_${i.key}" value="${i.units}">
    </div>
    <div style="opacity:.65; font-size:12px; margin-top:4px;">
      Sell: <b>${money(i.sell)}</b> ‚Ä¢ Cost/unit: <b>${money(unitCost(i))}</b> ‚Ä¢ Margin: <b>${money(i.sell - unitCost(i))}</b>
    </div>
  `).join("");
}

function saveCosts(){
  items = items.map(i => ({
    ...i,
    sell: parseFloat(document.getElementById(`sellE_${i.key}`).value || i.sell),
    cost: parseFloat(document.getElementById(`cost_${i.key}`).value || i.cost),
    units: parseFloat(document.getElementById(`units_${i.key}`).value || i.units),
  }));
  saveItems(items);
  alert("Saved ‚úÖ");
  refreshAllAdmin();
}

/* Sales */
function populateSaleDropdown(){
  const sel = document.getElementById("saleItem");
  if(!sel) return;
  sel.innerHTML = items.map(i => `<option value="${i.key}">${escapeHtml(i.name)} (${money(i.sell)})</option>`).join("");
}
function recordSale(){
  const key = document.getElementById("saleItem").value;
  const qty = Math.max(1, parseInt(document.getElementById("saleQty").value||"1",10));
  const note = (document.getElementById("saleNote").value||"").trim();
  const item = items.find(i=>i.key===key);
  if(!item) return;

  const sales = loadSales();
  sales.push({
    ts: Date.now(),
    key,
    name: item.name,
    qty,
    sell: item.sell,
    costPer: unitCost(item),
    note
  });
  saveSales(sales);

  document.getElementById("saleQty").value = 1;
  document.getElementById("saleNote").value = "";
  refreshAllAdmin();
}

/* Profit calcs */
function startOfDay(ts){ const d=new Date(ts); d.setHours(0,0,0,0); return d.getTime(); }
function startOfWeek(ts){
  const d=new Date(ts);
  const day=d.getDay();
  const diffToMon=(day===0?-6:1-day);
  d.setDate(d.getDate()+diffToMon);
  d.setHours(0,0,0,0);
  return d.getTime();
}
function remainingSellDaysThisWeek(nowTs){
  const todayStart = new Date(nowTs); todayStart.setHours(0,0,0,0);
  const weekStart = startOfWeek(nowTs);
  let count=0;
  for(let i=0;i<7;i++){
    const t=new Date(weekStart+i*86400000);
    const day=t.getDay();
    const sellDay = day !== 0 && day !== 6;
    if(t.getTime()>=todayStart.getTime() && sellDay) count++;
  }
  return Math.max(1,count);
}
function profitForRange(sales, fromTs, toTs){
  let rev=0, cogs=0;
  for(const s of sales){
    if(s.ts>=fromTs && s.ts<toTs){
      rev += s.sell * s.qty;
      cogs += s.costPer * s.qty;
    }
  }
  return { rev, cogs, profit: rev - cogs };
}
function dailyProfitSeries(daysBack=10){
  const sales=loadSales();
  const now=Date.now();
  const series=[];
  for(let i=daysBack-1;i>=0;i--){
    const dayStart=startOfDay(now - i*86400000);
    const dayEnd=dayStart+86400000;
    const p=profitForRange(sales, dayStart, dayEnd).profit;
    series.push({ dayStart, profit:p });
  }
  return series;
}

function destroyChart(id){ if(charts[id]){ charts[id].destroy(); delete charts[id]; } }

function renderProfitChart(){
  const canvas = document.getElementById("profitChart");
  if(!canvas) return;
  const series = dailyProfitSeries(10);
  const labels = series.map(x => new Date(x.dayStart).toLocaleDateString());
  const data = series.map(x => Math.round(x.profit*100)/100);

  destroyChart("profit");
  charts.profit = new Chart(canvas, {
    type: "line",
    data: { labels, datasets: [{ label:"Profit", data }] },
    options: {
      responsive:true,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ ticks:{ callback:(v)=>"$"+v } } }
    }
  });
}

function renderProfitTicker(){
  const sales = loadSales();
  const now = Date.now();
  const today = profitForRange(sales, startOfDay(now), startOfDay(now)+86400000);
  const weekStart = startOfWeek(now);
  const week = profitForRange(sales, weekStart, weekStart + 7*86400000);

  const ticker = document.getElementById("profitTicker");
  const meta = document.getElementById("profitMeta");
  const targetEl = document.getElementById("dailyTarget");
  if(!ticker || !meta || !targetEl) return;

  ticker.textContent = money(week.profit);
  ticker.style.color = week.profit >= 0 ? "#6dff9a" : "#ff6d6d";
  meta.textContent = `Today: ${money(today.profit)} ‚Ä¢ Week Revenue: ${money(week.rev)} ‚Ä¢ Week Cost: ${money(week.cogs)}`;

  const remain = remainingSellDaysThisWeek(now);
  const needed = week.profit < 0 ? Math.ceil((-week.profit / remain)*100)/100 : 0;

  targetEl.textContent = needed > 0
    ? `Today‚Äôs target to get back positive (spread over ${remain} sell days): ${money(needed)} profit/day`
    : `Today‚Äôs target: Keep it green ‚úÖ (you‚Äôre positive this week)`;

  // Split panels
  const half = week.profit / 2;
  const r = document.getElementById("rileyWeekly");
  const j = document.getElementById("jacksonWeekly");
  if(r) r.textContent = money(half);
  if(j) j.textContent = money(half);
}

/* Admin request ticker */
function computeTopRequests(threshold=5){
  const reqs = getRequests();
  const map = new Map();
  for(const r of reqs){
    const bucket = r.n.slice(0,18);
    map.set(bucket, (map.get(bucket)||0) + 1);
  }
  let best=null;
  for(const [bucket,count] of map.entries()){
    if(count>=threshold){
      if(!best || count>best.count) best={bucket,count};
    }
  }
  return best;
}
function renderAdminTicker(){
  const t = computeTopRequests(5);
  const el = document.getElementById("adminTicker");
  if(!el) return;
  if(!t){ el.style.display="none"; return; }
  const msg = `${t.count} people requested: ‚Äú${t.bucket}‚Ä¶‚Äù (consider adding it to the menu)`;
  el.style.display="block";
  el.setAttribute("data-text", msg + " ‚Ä¢ " + msg + " ‚Ä¢ " + msg);
}

/* Analytics placeholder */
function toggleAnalytics(){
  const p = document.getElementById("analyticsPanel");
  if(!p) return;
  p.style.display = (p.style.display==="none" || !p.style.display) ? "block" : "none";
  if(p.style.display==="block"){ showTab("mrr"); renderMRRCharts(); }
}
function showTab(name){
  ["mrr","nrr","growth","hot"].forEach(k=>{
    const el = document.getElementById("tab-"+k);
    if(el) el.style.display = (k===name) ? "block" : "none";
  });
}
function renderMRRCharts(){
  const mrrCtx = document.getElementById("mrrChart");
  if(mrrCtx){ destroyChart("mrr"); charts.mrr = new Chart(mrrCtx,{ type:"bar", data:{ labels:["Start","New","Churn","End"], datasets:[{ data:[0,0,0,0] }] }, options:{ plugins:{ legend:{display:false} } }}); }
  const nrrCtx = document.getElementById("nrrChart");
  if(nrrCtx){ destroyChart("nrr"); charts.nrr = new Chart(nrrCtx,{ type:"bar", data:{ labels:["NRR"], datasets:[{ data:[100] }] }, options:{ plugins:{ legend:{display:false} }, scales:{ y:{ suggestedMax:140, ticks:{ callback:v=>v+"%" } } } }}); }
  const gCtx = document.getElementById("growthChart");
  if(gCtx){ destroyChart("growth"); charts.growth = new Chart(gCtx,{ type:"line", data:{ labels:["Now"], datasets:[{ data:[0] }] }, options:{ plugins:{ legend:{display:false} } }}); }
  const hotCtx = document.getElementById("hotChart");
  if(hotCtx){
    const sales = loadSales();
    const counts = new Map();
    for(const s of sales) counts.set(s.name, (counts.get(s.name)||0) + s.qty);
    const sorted=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8);
    destroyChart("hot");
    charts.hot = new Chart(hotCtx,{ type:"bar", data:{ labels: sorted.map(x=>x[0]), datasets:[{ data: sorted.map(x=>x[1]) }] }, options:{ plugins:{ legend:{display:false} } }});
  }
}

/* Master refresh */
function refreshAllAdmin(){
  items = loadItems();
  renderMenu();
  populateSaleDropdown();
  renderItemList();
  renderCostEditor();
  renderProfitTicker();
  renderProfitChart();
  renderAdminTicker();
  loadAdmin();
}

/* Initial render (so menu works even before admin) */
renderMenu();
</script>
</body>
</html>
